<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ù†Ù‘Ùƒ Ù„Ø¥Ù„Ùƒ </title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#0ea5a4; /* teal */
      --accent:#06b6d4;
      --dark:#0f172a;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f8fafc;
      --success:#16a34a;
      --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:'Cairo',sans-serif}
    body{margin:0;background:var(--bg);color:var(--dark);line-height:1.4}
    header{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:#fff;color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700}
    .nav{display:flex;gap:10px;align-items:center}
    .btn{background:#fff;color:var(--primary);padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .container{max-width:1100px;margin:18px auto;padding:0 16px}
    .search-bar{display:flex;gap:8px;margin-bottom:14px}
    input[type="search"]{flex:1;padding:10px;border-radius:10px;border:1px solid #e6e9ef}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06);position:relative}
    .card img{width:100%;height:150px;object-fit:cover;border-radius:8px}
    .title{font-weight:700;margin-top:8px}
    .meta{color:var(--muted);font-size:14px}
    .price{color:var(--primary);font-weight:700;margin-top:6px}
    footer{padding:18px;text-align:center;color:var(--muted)}
    .fav-btn{position:absolute;left:10px;top:10px;background:rgba(255,255,255,0.9);border-radius:8px;padding:6px;cursor:pointer}
    .small{font-size:13px}
    /* details */
    .details{display:flex;gap:18px;flex-wrap:wrap}
    .left{flex:1;min-width:280px}
    .right{width:320px}
    .recommend{background:#f1f6f6;padding:10px;border-radius:10px;margin-top:12px}
    /* dashboard */
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:14px;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px}
    .chat-widget{position:fixed;left:18px;bottom:18px;width:340px;max-width:90%;box-shadow:0 10px 30px rgba(2,6,23,0.2)}
    .chat-header{background:var(--primary);color:#fff;padding:10px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center}
    .chat-body{background:#fff;height:280px;overflow:auto;padding:12px}
    .chat-input{display:flex;padding:10px;background:#fff;border-radius:0 0 10px 10px;gap:8px}
    .msg{margin:8px 0;padding:8px 10px;border-radius:12px;max-width:80%}
    .msg.user{background:linear-gradient(90deg,#e6fffb,#ccfbf1);margin-left:auto}
    .msg.bot{background:#f1f5f9}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:40}
    .modal .card{width:420px}
    .hidden{display:none}
    /* rating */
    .stars{display:flex;gap:6px}
    .star{cursor:pointer;font-size:20px}
    /* toast */
    .toast{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 8px 24px rgba(2,6,23,0.3)}
    /* responsive */
    @media (max-width:640px){
      .details{flex-direction:column}
      .right{width:100%}
      header{padding:12px}
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div class="logo">Ù…Ù€Ù„</div>
      <div>
        <div style="font-weight:700">Ù…Ù†Ù‘Ùƒ Ù„Ø¥Ù„Ùƒ</div>
        <div style="font-size:13px;opacity:.9">Ù…Ù†ØµØ© Ø°ÙƒÙŠØ© Ù„ØªØ£Ø¬ÙŠØ± Ø§Ù„Ø£Ø¯ÙˆØ§Øª</div>
      </div>
    </div>

    <nav class="nav">
      <div id="userArea" style="display:flex;align-items:center;gap:8px">
        <!-- login area will be rendered here -->
      </div>
      <button class="btn" id="to-add">Ø£Ø¶Ù Ø£Ø¯Ø§Ø©</button>
      <button class="btn" id="to-dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      <button class="btn" id="to-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </nav>
  </header>

  <main class="container" id="app">

    <!-- Landing / Search -->
    <section id="homeView">
      <div class="search-bar">
        <input type="search" id="query" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¯Ø§Ø© Ø£Ùˆ Ù…ÙˆÙ‚Ø¹..." autocomplete="off" />
        <select id="categoryFilter">
          <option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
          <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
          <option value="Ø¨Ù†Ø§Ø¡">Ø£Ø¯ÙˆØ§Øª Ø¨Ù†Ø§Ø¡</option>
          <option value="ØªÙ†Ø¸ÙŠÙ">Ø£Ø¯ÙˆØ§Øª ØªÙ†Ø¸ÙŠÙ</option>
          <option value="ØªØµÙˆÙŠØ±">Ø£Ø¯ÙˆØ§Øª ØªØµÙˆÙŠØ±</option>
        </select>
        <button class="btn" id="searchBtn">Ø§Ø¨Ø­Ø«</button>
      </div>

      <div class="row" style="align-items:center;justify-content:space-between">
        <h2>Ø£Ø¯ÙˆØ§Øª Ù…ØªØ§Ø­Ø©</h2>
        <div class="meta">Ù…Ø«Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ø§Ù„Ù‡Ø§ÙƒØ§Ø«ÙˆÙ†</div>
      </div>

      <div id="toolsGrid" class="grid" style="margin-top:12px"></div>
    </section>

    <!-- Details -->
    <section id="detailsView" style="display:none">
      <button class="btn" id="backToHome" style="margin-bottom:12px">Ø¹ÙˆØ¯Ø©</button>
      <div class="card details">
        <div class="left">
          <img id="detailImage" src="" alt="Ø£Ø¯Ø§Ø©" style="width:100%;height:320px;object-fit:cover;border-radius:8px" />
          <h3 id="detailTitle" style="margin-top:12px"></h3>
          <div id="detailDesc" class="meta" style="margin-top:8px"></div>
          <div class="price" id="detailPrice" style="margin-top:10px"></div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button class="btn" id="rentBtn">Ø§Ø³ØªØ£Ø¬Ø± Ø§Ù„Ø¢Ù†</button>
            <div class="small" id="avgRating">â€”</div>
          </div>

          <div class="recommend">
            <strong>ØªÙˆØµÙŠØ§Øª Ø°ÙƒÙŠØ©</strong>
            <ul id="recommendList" style="padding-left:18px;margin-top:8px"></ul>
          </div>
        </div>

        <aside class="right card">
          <div style="font-weight:700">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¤Ø¬Ø±</div>
          <div class="meta" id="ownerInfo">â€”</div>

          <div style="margin-top:12px">
            <div class="meta">Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¯Ø§Ø©</div>
            <div id="toolCondition">â€”</div>
          </div>

          <div style="margin-top:12px">
            <div class="meta">Ø§Ù„ØªÙˆÙØ±</div>
            <div id="toolAvail">ÙÙˆØ±ÙŠ</div>
          </div>

          <div style="margin-top:12px">
            <div class="meta">Ù‚ÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø©</div>
            <div class="stars" id="rateControl"></div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Add tool -->
    <section id="addView" style="display:none">
      <button class="btn" id="backFromAdd" style="margin-bottom:12px">Ø¹ÙˆØ¯Ø©</button>
      <div class="card" style="padding:18px">
        <h3>Ø£Ø¶Ù Ø£Ø¯Ø§Ø© Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±</h3>
        <div style="margin-top:12px">
          <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©</label>
          <input id="inputTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¯Ø±ÙŠÙ„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Bosch 750W" />
        </div>
        <div style="margin-top:12px">
          <label>Ø§Ù„ÙØ¦Ø©</label>
          <select id="inputCategory">
            <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
            <option value="Ø¨Ù†Ø§Ø¡">Ø£Ø¯ÙˆØ§Øª Ø¨Ù†Ø§Ø¡</option>
            <option value="ØªÙ†Ø¸ÙŠÙ">Ø£Ø¯ÙˆØ§Øª ØªÙ†Ø¸ÙŠÙ</option>
            <option value="ØªØµÙˆÙŠØ±">Ø£Ø¯ÙˆØ§Øª ØªØµÙˆÙŠØ±</option>
          </select>
        </div>
        <div style="margin-top:12px">
          <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø¯.Ø£)</label>
          <input id="inputPrice" type="number" value="5" />
        </div>
        <div style="margin-top:12px">
          <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
          <input id="inputCity" value="Ø§Ù„Ù…ÙØ±Ù‚" />
        </div>
        <div style="margin-top:12px">
          <label>ØµÙˆØ±Ø© Ø§Ù„Ø£Ø¯Ø§Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="inputImage" type="file" accept="image/*" />
          <div id="preview" style="margin-top:8px"></div>
        </div>
        <div style="margin-top:12px">
          <label>ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="inputDesc" rows="3" placeholder="Ø£Ø¶Ù ÙˆØµÙÙ‹Ø§ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ Ù„ÙŠØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ ÙˆØµÙ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§"></textarea>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="addToolBtn">Ø£Ø¶Ù Ø§Ù„Ø£Ø¯Ø§Ø©</button>
          <button class="btn" id="aiDescribeBtn" style="background:#fff;color:var(--primary)">Ø§Ù‚ØªØ±Ø­ ÙˆØµÙ (AI)</button>
      
  </div>
        <div id="addMsg" class="meta" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Dashboard -->
    <section id="dashView" style="display:none">
      <button class="btn" id="backFromDash" style="margin-bottom:12px">Ø¹ÙˆØ¯Ø©</button>
      <div class="row">
        <div class="card" style="flex:1;min-width:300px">
          <h3>Ø£Ø¯ÙˆØ§ØªÙŠ</h3>
          <div id="myToolsList" style="margin-top:8px"></div>
        </div>
        <div class="card" style="width:360px">
          <h3>Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</h3>
          <div id="myBookings">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</div>
        </div>
      </div>
    </section>

  </main>

  

  <!-- Login Modal -->
  <div id="loginModal" class="modal hidden">
    <div class="card" style="padding:16px">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹</h3>
      <div style="margin-top:8px">
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input id="loginName" placeholder="Ø§Ø³Ù…Ùƒ" />
      </div>
      <div style="margin-top:8px">
        <label>ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="loginAvatar" type="file" accept="image/*" />
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button class="btn" id="doLogin">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" id="closeLogin">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Toast placeholder -->
  <div id="toastRoot"></div>

<script>
/* ========== Utilities & Persistence ========== */
const LS_TOOLS_KEY = 'mank_tools_v1';
const LS_USER_KEY = 'mank_user_v1';

function toast(msg, time=2500){
  const t = document.createElement('div'); t.className='toast'; t.innerText=msg;
  document.getElementById('toastRoot').appendChild(t);
  setTimeout(()=> t.remove(), time);
}

function saveTools(arr){ localStorage.setItem(LS_TOOLS_KEY, JSON.stringify(arr)); }
function loadTools(){ try{ return JSON.parse(localStorage.getItem(LS_TOOLS_KEY)) || null }catch(e){ return null }}
function saveUser(u){ localStorage.setItem(LS_USER_KEY, JSON.stringify(u)); }
function loadUser(){ try{ return JSON.parse(localStorage.getItem(LS_USER_KEY)) || null }catch(e){ return null }}

/* ===== Default demo tools (used only if nothing in storage) ===== */
const defaultTools = [
  { id: 't1', title: 'Ø¯Ø±ÙŠÙ„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Bosch 750W', desc: 'Ø¯Ø±ÙŠÙ„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ Ø¨Ù‚Ø¯Ø±Ø© 750 ÙˆØ§Ø·ØŒ Ø­Ø§Ù„Ø© Ù…Ù…ØªØ§Ø²Ø©ØŒ Ù…Ù†Ø§Ø³Ø¨ Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©.', price: 8, city: 'Ø§Ù„Ù…ÙØ±Ù‚', category: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', owner: {name:'Ø£Ø­Ù…Ø¯', rating:4.7}, condition: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§', image: 'https://images.unsplash.com/photo-1581091870622-3d45b04f1f4d?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=8c3b3b9ed3c5521f0c4d01d2c7a2d1b2', favorites:[], ratings: [] },
  { id: 't2', title: 'Ù…Ø§ÙƒÙŠÙ†Ø© Ù„Ø­Ø§Ù… Ù…Ø­Ù…ÙˆÙ„Ø©', desc: 'Ù…Ø§ÙƒÙŠÙ†Ø© Ù„Ø­Ø§Ù… Ø®ÙÙŠÙØ© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø´ØºÙ„ ØµØºÙŠØ± ÙˆØ®ÙÙŠÙØŒ ØªØ¹Ù…Ù„ Ø¨Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡.', price: 20, city: 'Ø¹Ù…Ø§Ù†', category: 'Ø¨Ù†Ø§Ø¡', owner: {name:'Ø³Ù„ÙŠÙ…', rating:4.5}, condition: 'Ù…Ø³ØªØ¹Ù…Ù„Ø© Ø¨Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø©', image: 'https://images.unsplash.com/photo-1556761175-4b46a572b786?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=ea6f2f5a3f2f6fca0f8b1a73b6d2c3f4', favorites:[], ratings: [] },
  { id: 't3', title: 'ÙƒØ§Ù…ÙŠØ±Ø§ ÙƒØ§Ù†ÙˆÙ† (Ù„Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø§Ù„ØªØµÙˆÙŠØ±ÙŠØ©)', desc: 'ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ØªØµÙˆÙŠØ± Ø­ÙÙ„Ø§Øª ÙˆØ£Ø¹Ù…Ø§Ù„ ØªØ¬Ø§Ø±ÙŠØ©.', price: 45, city: 'Ø§Ù„Ù…ÙØ±Ù‚', category: 'ØªØµÙˆÙŠØ±', owner: {name:'Ù„ÙŠÙ„Ù‰', rating:4.9}, condition: 'Ø¬Ø¯ÙŠØ¯Ø©', image: 'https://images.unsplash.com/photo-1519183071298-a2962be54a19?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=7f6c3d9b6b8d4b1c9a7b8c6d5e4f3a2b', favorites:[], ratings: [] }
];

let tools = loadTools() || defaultTools.slice();
let currentUser = loadUser();
let lastSearchResults = tools.slice();

/* ===== DOM Elements ===== */
const toolsGrid = document.getElementById('toolsGrid');
const queryEl = document.getElementById('query');
const categoryFilter = document.getElementById('categoryFilter');
const searchBtn = document.getElementById('searchBtn');

/* ===== Render Header User Area ===== */
function renderUserArea(){
  const root = document.getElementById('userArea'); root.innerHTML='';
  if(currentUser){
    const avatar = document.createElement('img'); avatar.src = currentUser.avatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36"><rect fill="%230ea5a4" rx="8" width="36" height="36"/></svg>';
    avatar.style.width='36px'; avatar.style.height='36px'; avatar.style.borderRadius='8px'; avatar.style.objectFit='cover';
    const name = document.createElement('div'); name.innerHTML = `<div style="font-weight:700">${currentUser.name}</div><div class="small">Ù…Ø§Ù„Ùƒ</div>`;
    const logout = document.createElement('button'); logout.className='btn'; logout.innerText='ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬'; logout.onclick = ()=>{ currentUser=null; saveUser(null); renderUserArea(); toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); };
    root.appendChild(avatar); root.appendChild(name); root.appendChild(logout);
  } else {
    const loginBtn = document.createElement('button'); loginBtn.className='btn'; loginBtn.innerText='ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„'; loginBtn.onclick = ()=>{ document.getElementById('loginModal').classList.remove('hidden'); };
    root.appendChild(loginBtn);
  }
}
renderUserArea();

/* ===== Render Tools Grid ===== */
function renderTools(list){
  toolsGrid.innerHTML = '';
  if(!list.length){ toolsGrid.innerHTML = '<div class="card meta">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¯ÙˆØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</div>'; return; }
  list.forEach(t=>{
    const el = document.createElement('div'); el.className='card';
    // favorite state for current user
    const fav = currentUser && t.favorites && t.favorites.includes(currentUser.name);
    el.innerHTML = `
      <button class="fav-btn" title="Ø£Ø¶Ù Ù„Ù„Ù…ÙØ¶Ù„Ø©">${fav? 'â˜…' : 'â˜†'}</button>
      <img src="${t.image}" alt="${t.title}" />
      <div class="title">${t.title}</div>
      <div class="meta">${t.city} â€¢ ${t.category}</div>
      <div class="price">${t.price} Ø¯.Ø£ / ÙŠÙˆÙ…</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" data-id="${t.id}" onclick="openDetails('${t.id}')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
        <button style="background:#eef" onclick="quickRent('${t.id}')">Ø§Ø³ØªØ£Ø¬Ø± Ø³Ø±ÙŠØ¹</button>
      </div>
    `;
    const favBtn = el.querySelector('.fav-btn');
    favBtn.addEventListener('click', ()=> toggleFavorite(t.id, favBtn));

    toolsGrid.appendChild(el);
  });
}

/* ===== Search & Filter (improved) ===== */
function searchTools(){
  const q = queryEl.value.trim();
  const cat = categoryFilter.value;
  const res = tools.filter(t=>{
    const hay = (t.title+ ' ' + t.desc + ' ' + t.city + ' ' + t.category).toLowerCase();
    const matchQ = !q || hay.includes(q.toLowerCase());
    const matchC = !cat || t.category===cat;
    return matchQ && matchC;
  });
  lastSearchResults = res.slice();
  renderTools(res);
}
searchBtn.addEventListener('click', searchTools);
queryEl.addEventListener('keyup', (e)=>{ if(e.key==='Enter') searchTools(); });

/* ===== Details ===== */
const detailsView = document.getElementById('detailsView');
const homeView = document.getElementById('homeView');
const addView = document.getElementById('addView');
const dashView = document.getElementById('dashView');

function openDetails(id){
  const t = tools.find(x=>x.id===id);
  if(!t) return;
  document.getElementById('detailImage').src = t.image;
  document.getElementById('detailTitle').innerText = t.title;
  document.getElementById('detailDesc').innerText = t.desc;
  document.getElementById('detailPrice').innerText = t.price + ' Ø¯.Ø£ / ÙŠÙˆÙ…';
  document.getElementById('ownerInfo').innerText = `${t.owner.name} â€¢ ØªÙ‚ÙŠÙŠÙ… ${t.owner.rating}`;
  document.getElementById('toolCondition').innerText = t.condition;
  // recommendations
  const recList = document.getElementById('recommendList'); recList.innerHTML='';
  const recs = generateRecommendations(t);
  recs.forEach(r=>{ const li = document.createElement('li'); li.innerText = r; recList.appendChild(li); });

  // average rating
  const avg = t.ratings && t.ratings.length? (t.ratings.reduce((s,v)=>s+v,0)/t.ratings.length).toFixed(1) : 'â€”';
  document.getElementById('avgRating').innerText = avg!=='â€”' ? `â­ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${avg}` : 'Ù„Ø§ ØªÙ‚ÙŠÙŠÙ… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†';

  // render rate control
  const rc = document.getElementById('rateControl'); rc.innerHTML='';
  for(let i=1;i<=5;i++){
    const s = document.createElement('span'); s.className='star'; s.innerText='â˜†'; s.dataset.val = i;
    s.onclick = ()=>{ rateTool(id, i); }
    rc.appendChild(s);
  }

  homeView.style.display='none'; addView.style.display='none'; dashView.style.display='none';
  detailsView.style.display='block';
}

document.getElementById('backToHome').addEventListener('click', ()=>{ detailsView.style.display='none'; homeView.style.display='block'; renderTools(lastSearchResults); });

/* ===== Recommendations (same rules) ===== */
function generateRecommendations(tool){
  const recs = [];
  if(tool.category==='Ø¨Ù†Ø§Ø¡'){ recs.push('Ø®ÙˆØ°Ø© Ø£Ù…Ø§Ù† ğŸª–'); recs.push('Ù†Ø¸Ø§Ø±Ø§Øª Ø­Ù…Ø§ÙŠØ© ğŸ‘“'); }
  if(tool.category==='ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©'){ recs.push('Ø·Ù‚Ù… Ù…ÙÙƒØ§Øª'); recs.push('Ø³Ù„Ùƒ ØªÙ…Ø¯ÙŠØ¯ 10Ù…'); }
  if(tool.category==='ØªØµÙˆÙŠØ±'){ recs.push('Ø­Ø§Ù…Ù„ Ø«Ù„Ø§Ø«ÙŠ (Tripod)'); recs.push('Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©'); }
  if(!recs.length){ recs.push('Ù‚ÙØ§Ø²Ø§Øª Ø¹Ù…Ù„'); recs.push('Ø­Ù‚ÙŠØ¨Ø© Ù„Ù„Ù†Ù‚Ù„'); }
  return recs;
}

/* ===== Quick Rent (mock) ===== */
function quickRent(id){
  if(!currentUser){ toast('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø­Ø¬Ø²'); document.getElementById('loginModal').classList.remove('hidden'); return; }
  toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø§Ø³ØªØ¦Ø¬Ø§Ø± â€” Ø³ÙŠØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ Ù„Ø§Ø­Ù‚Ù‹Ø§');
}

/* ===== Add tool (with image preview) ===== */
document.getElementById('to-add').addEventListener('click', ()=>{ homeView.style.display='none'; detailsView.style.display='none'; dashView.style.display='none'; addView.style.display='block'; });
document.getElementById('backFromAdd').addEventListener('click', ()=>{ addView.style.display='none'; homeView.style.display='block'; renderTools(lastSearchResults); });

const inputImage = document.getElementById('inputImage');
inputImage.addEventListener('change', ()=>{
  const f = inputImage.files[0];
  if(!f) return; const reader = new FileReader(); reader.onload = e=>{ document.getElementById('preview').innerHTML = `<img src="${e.target.result}" style="width:120px;border-radius:8px;">`; inputImage.dataset.data = e.target.result; };
  reader.readAsDataURL(f);
});

document.getElementById('addToolBtn').addEventListener('click', ()=>{
  const title = document.getElementById('inputTitle').value.trim();
  const price = Number(document.getElementById('inputPrice').value) || 5;
  const city = document.getElementById('inputCity').value.trim() || 'Ø§Ù„Ù…ÙØ±Ù‚';
  const cat = document.getElementById('inputCategory').value;
  let desc = document.getElementById('inputDesc').value.trim();
  if(!title){ document.getElementById('addMsg').innerText='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©'; return; }
  if(!desc){ desc = title + ' â€” ÙˆØµÙ Ù…Ù‚ØªØ±Ø­: Ø£Ø¯Ø§Ø© Ø¨Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø©.' }
  const image = inputImage.dataset.data || 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=efb2b4c8b2c6f0e2d2d8b8a3c1d2e3f4';
  const newTool = { id: 't'+(Date.now()), title, desc, price, city, category:cat, owner:{name: currentUser? currentUser.name : 'Ø£Ù†Øª', rating: currentUser? 5 : 4.5}, condition:'Ø¬Ø¯ÙŠØ¯', image, favorites: [], ratings: [] };
  tools.unshift(newTool);
  saveTools(tools);
  document.getElementById('addMsg').innerText='ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­!';
  document.getElementById('inputTitle').value=''; document.getElementById('inputDesc').value=''; document.getElementById('preview').innerHTML=''; delete inputImage.dataset.data; toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ø§Ø©');
  renderTools(tools);
});

/* ===== AI Describe (mock) ===== */
document.getElementById('aiDescribeBtn').addEventListener('click', ()=>{
  const title = document.getElementById('inputTitle').value.trim();
  if(!title){ document.getElementById('addMsg').innerText='Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙŠØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ ÙˆØµÙ.'; return; }
  // Simple local heuristic instead of live API
  const desc = `${title} â€” Ø£Ø¯Ø§Ø© Ø¨Ø­Ø§Ù„Ø© Ù…Ù…ØªØ§Ø²Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ ÙˆØ§Ù„Ù…Ù‡Ù†ÙŠ Ø§Ù„ØµØºÙŠØ±. ØªØ´Ù…Ù„ Ø§Ù„Ø¥Ø³ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ø§Ø¦Ù… ÙˆØ³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.`;
  document.getElementById('inputDesc').value = desc;
  document.getElementById('addMsg').innerText='ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ ÙˆØµÙ Ø¨ÙˆØ§Ø³Ø·Ø© (AI) ØªØ¬Ø±ÙŠØ¨ÙŠ.';
});

/* ===== Dashboard ===== */
document.getElementById('to-dashboard').addEventListener('click', ()=>{ homeView.style.display='none'; detailsView.style.display='none'; addView.style.display='none'; dashView.style.display='block'; renderMyTools(); });
document.getElementById('backFromDash').addEventListener('click', ()=>{ dashView.style.display='none'; homeView.style.display='block'; renderTools(lastSearchResults); });

function renderMyTools(){
  const el = document.getElementById('myToolsList'); el.innerHTML='';
  tools.forEach(t=>{
    const div = document.createElement('div');
    div.style.padding='8px 0'; div.style.borderBottom='1px dashed #eef';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${t.title}</strong><div class="meta">${t.city} â€¢ ${t.price} Ø¯.Ø£</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="openDetails('${t.id}')">Ø¹Ø±Ø¶</button>
        <button class="btn" onclick="deleteTool('${t.id}')" style="background:var(--danger);color:#fff">Ø­Ø°Ù</button>
      </div>
    </div>`;
    el.appendChild(div);
  });
}

function deleteTool(id){ if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©ØŸ')) return; tools = tools.filter(t=>t.id!==id); saveTools(tools); renderMyTools(); renderTools(tools); toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø¯Ø§Ø©'); }

/* ===== Favorites ===== */
function toggleFavorite(id, btn){ if(!currentUser){ toast('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©'); document.getElementById('loginModal').classList.remove('hidden'); return; }
  const t = tools.find(x=>x.id===id); if(!t) return;
  const idx = t.favorites.indexOf(currentUser.name);
  if(idx===-1) t.favorites.push(currentUser.name); else t.favorites.splice(idx,1);
  saveTools(tools); renderTools(lastSearchResults.length? lastSearchResults : tools); toast(idx===-1? 'Ø£Ø¶ÙŠÙØª Ù„Ù„Ù…ÙØ¶Ù„Ø©' : 'Ø£ÙØ²ÙŠÙ„Øª Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©');
}

/* ===== Rating ===== */
function rateTool(id, val){ if(!currentUser){ toast('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„ØªÙ‚ÙŠÙ… Ø§Ù„Ø£Ø¯ÙˆØ§Øª'); document.getElementById('loginModal').classList.remove('hidden'); return; }
  const t = tools.find(x=>x.id===id); if(!t) return; t.ratings = t.ratings || [];
  // For simplicity allow multiple ratings from same user by replacing previous
  const prevIdx = t.ratingsUserIndex ? t.ratingsUserIndex[currentUser.name] : -1;
  if(!t.ratingsUserIndex) t.ratingsUserIndex = {};
  if(t.ratingsUserIndex[currentUser.name]){
    // replace: remove previous from ratings array by index info stored
    t.ratings[t.ratingsUserIndex[currentUser.name]-1] = val; // simple approach
  } else {
    t.ratings.push(val);
    t.ratingsUserIndex[currentUser.name] = t.ratings.length;
  }
  saveTools(tools);
  toast('Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ');
  openDetails(id); // refresh view
}

/* ===== Login modal actions ===== */
document.getElementById('closeLogin').addEventListener('click', ()=> document.getElementById('loginModal').classList.add('hidden'));
document.getElementById('doLogin').addEventListener('click', ()=>{
  const name = document.getElementById('loginName').value.trim();
  const f = document.getElementById('loginAvatar').files[0];
  if(!name){ alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ'); return; }
  if(f){ const r=new FileReader(); r.onload=e=>{ currentUser = { name, avatar: e.target.result }; saveUser(currentUser); renderUserArea(); document.getElementById('loginModal').classList.add('hidden'); toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); } ; r.readAsDataURL(f); }
  else { currentUser = { name }; saveUser(currentUser); renderUserArea(); document.getElementById('loginModal').classList.add('hidden'); toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); }
});

/* ===== Simple chatbot (kept mock) ===== */
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
document.getElementById('sendChat').addEventListener('click', sendChat);
chatInput.addEventListener('keyup', (e)=>{ if(e.key==='Enter') sendChat(); });

function sendChat(){ const text = chatInput.value.trim(); if(!text) return; appendMsg(text,'user'); chatInput.value=''; setTimeout(()=>{ const reply = botReply(text); appendMsg(reply,'bot'); chatBody.scrollTop = chatBody.scrollHeight; },500); }
function appendMsg(text,who){ const d=document.createElement('div'); d.className='msg ' + (who==='user'?'user':'bot'); d.innerText=text; chatBody.appendChild(d); }
function botReply(text){ const t=text.toLowerCase(); if(t.includes('ÙƒÙŠÙ') && t.includes('Ø£Ø¬Ø±')) return 'Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø© -> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -> Ø§Ø³ØªØ£Ø¬Ø±. Ø¨Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ø®ØªØ§Ø± Ù…Ø¯ÙŠÙ†Ø©ØŸ'; if(t.includes('Ø§Ù„Ù…ÙØ±Ù‚')) return 'Ø¨Ø§Ù„Ù…ÙØ±Ù‚ Ø¯Ø±ÙŠÙ„ 8 Ø¯.Ø£ ÙˆÙƒØ§Ù…ÙŠØ±Ø§ 45 Ø¯.Ø£ â€” ØªØ­Ø¨ ØªØ´ÙˆÙÙ‡Ù…ØŸ'; if(t.includes('Ø£Ø±Ø®Øµ')) return 'Ø¹Ø§ÙŠØ² Ø£Ø±Ø®Øµ Ø­Ø³Ø¨ Ø£ÙŠ Ù…Ø¯ÙŠÙ†Ø©ØŸ'; if(t.includes('Ù‡Ù„Ø§')||t.includes('Ù…Ø±Ø­Ø¨Ø§')) return 'ÙŠØ§ Ù‡Ù„Ø§! ÙƒÙŠÙ Ø¨Ø³Ø§Ø¹Ø¯ÙƒØŸ'; return 'ÙˆØµÙ„ Ø³Ø¤Ø§Ù„Ùƒ â€” Ù…Ù…ÙƒÙ† ØªÙˆØ¶Ø­ Ø´ÙˆÙŠØŸ'; }

/* ===== Init render ===== */
function init(){ renderUserArea(); renderTools(tools); }
init();

// expose some functions for inline onclick
window.openDetails = openDetails;
window.quickRent = quickRent;
window.deleteTool = deleteTool;
window.toggleFavorite = toggleFavorite;
window.rateTool = rateTool;
</script>
</body>
</html>
